# 纵向肺结节分割系统架构（精简版）

## 1. 纵向模型架构
**文件**: `llava/model/longitudinal_arch.py`  
**主数据流**:
```
双时相图像 [B,3,224,224] 
→ CLIP-ViT → 图像特征 [B,256,16,16]
→ 变化融合 → 变化特征 [B,256,16,16]
→ 文本条件化 → 条件特征 [B,256,16,16]
→ 分割解码 → logits [B,1,224,224]
```

## 2. 对话模板系统
**文件**: `llava/conversation_longitudinal.py`  
**主数据流**:
```
任务类型 + 变化指标 → 指令字符串 → token序列 [B,512]
```

## 3. 数据生成器
**文件**: `llava/data/lidc_longitudinal_data_generator.py`  
**主数据流**:
```
DICOM路径列表 → 读取 → 图像 [B,3,224,224] + 掩码 [B,1,224,224] + 变化指标 dict
```

## 4. 变化计算器
**文件**: `llava/data/longitudinal_changes.py`  
**主数据流**:
```
双掩码 [B,1,H,W] → 体积/密度/直径变化 dict
```

## 5. 图像配准模块
**文件**: `llava/data/longitudinal_registration.py`  
**主数据流**:
```
双时相图像 [2,H,W,3] → 配准 → 变换矩阵 → 对齐图像 [2,H,W,3]
```

## 6. 评估指标模块
**文件**: `llava/metrics_longitudinal.py`  
**主数据流**:
```
预测掩码 [B,1,H,W] + 真值掩码 [B,1,H,W] → Dice, IoU, 表面距离 dict
```

## 7. 训练模块
**文件**: `llava/train/train_longitudinal.py`  
**主数据流**:
```
双图像 [B,3,224,224] + 指令 [B,512] + 目标掩码 [B,1,224,224]
→ 前向 → logits [B,1,224,224]
→ 损失计算 → 标量
```

## 8. 推理模块
**文件**: `llava/inference_longitudinal_demo.py`  
**主数据流**:
```
双图像 [H,W,3] + 指令 str → 分割掩码 [H,W,1] + 变化掩码 [H,W,1] + 置信度 float
```

## 9. 配置管理模块
**文件**: `configs/longitudinal_lidc_config.json`  
**主数据流**:
```
JSON文件 → 解析 → 配置对象
```

## 10. 工具模块
**文件**: `llava/mm_utils.py`  
**主数据流**:
```
任意图像 [H,W,3] → 标准化 → [224,224,3]
```

## 训练阶段数据流
```
输入数据
├── 双时相图像 [B,3,224,224]
├── 指令文本 [B,512]
└── 目标掩码 [B,1,224,224]

↓

特征提取 (冻结CLIP-ViT)
├── 图像特征_t0 [B,256,16,16]
└── 图像特征_t1 [B,256,16,16]

↓

变化建模
├── 特征拼接/差分 [B,512,16,16]
└── 变化投影 [B,256,16,16]

↓

文本条件化
├── 文本特征提取 [B,C_text]
└── 空间条件化 [B,256,16,16]

↓

分割解码
└── 分割logits [B,1,224,224]

↓

损失计算
├── 分割损失 (BCE + Dice)
├── 变化一致性损失
└── 指令遵循损失
```

## 推理阶段数据流
```
输入数据
├── 双时相图像 [1,3,224,224]
└── 指令文本 [1,512]

↓

特征提取 → 变化建模 → 文本条件化 → 分割解码
└── 分割概率 [1,1,224,224]

↓

后处理
├── 二值化掩码 [1,1,224,224]
├── 变化检测图 [1,1,224,224]
└── 置信度分数 float
```

## 数据流总结
- 所有模块统一使用NCHW格式
- 批维度B可动态调整（1~32）
- 图像输入固定224×224，输出同分辨率掩码
- 文本统一512 token长度
- 变化指标以字典形式传递
    